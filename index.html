<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eritrean International League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Ø§Ù„Ø®Ø·ÙˆØ· */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f8ff; /* Light Blue Background */
        }
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¶Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .header-bar {
            background-color: #1e8449; /* Dark Green */
            color: white;
        }
        /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø§Ø¦ÙŠ */
        .main-content-bg {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="%23d6eefb" stroke-width="8"/><circle cx="50" cy="50" r="30" fill="none" stroke="%23b3e0f9" stroke-width="6"/></svg>');
            background-repeat: repeat;
            padding-top: 2rem;
        }
        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Sections) */
        .page-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s;
        }
        .card-shadow:hover {
            transform: translateY(-5px);
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ */
        .standings-table th {
            background-color: #1e8449;
            color: white;
            padding: 1rem;
            text-align: right;
        }
    </style>
</head>
<body onload="initializeApp()">

    <header class="header-bar shadow-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center py-3 px-4 sm:px-6 lg:px-8">
            <h1 class="text-xl sm:text-2xl font-bold">Eritrean International League</h1>
            <nav class="space-x-4 space-x-reverse text-sm sm:text-base">
                <a href="#" class="nav-button hover:underline" data-target="home">Home</a>
                <a href="#" class="nav-button hover:underline" data-target="teams">Teams</a>
                <a href="#" class="nav-button hover:underline" data-target="matches">Matches</a>
                <a href="#" class="nav-button hover:underline" data-target="standings">Standings</a>
                <a href="#" class="nav-button hover:underline" data-target="admin">Admin</a>
            </nav>
        </div>
    </header>

    <main class="main-content-bg min-h-screen">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

            <section id="home" class="page-section active pt-8 pb-12">
                <h2 class="text-4xl font-bold text-center text-blue-800 mb-8">Eritrean International League</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <p class="text-lg text-gray-700 text-center">
                        Welcome to the official platform for the Eritrean International League. Here you can find the latest standings, match results, and participating teams.
                    </p>
                    <div class="mt-6 text-center">
                        <img src="https://placehold.co/600x200/d6eefb/1e8449?text=League+Banner+or+Logo" alt="League Banner" class="mx-auto rounded-lg">
                    </div>
                </div>
            </section>

            <section id="teams" class="page-section pt-8 pb-12">
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-10">Participating Teams</h2>
                <div id="teams-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 justify-items-center">
                    </div>
            </section>

            <section id="matches" class="page-section pt-8 pb-12">
                <h2 class="text-3xl font-bold text-center text-red-700 mb-8">Past Matches</h2>
                <div id="past-matches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

                <h2 id="upcoming-matches-heading" class="text-3xl font-bold text-center text-blue-800 mt-12 mb-8">Upcoming Matches</h2>
                <div id="upcoming-matches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </section>

            <section id="standings" class="page-section pt-8 pb-12">
                <h2 class="text-3xl font-bold text-center text-green-700 mb-8">League Standings</h2>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200 standings-table text-right">
                        <thead>
                            <tr>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">#</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">Team</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">MP</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">W</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">D</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">L</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">GF</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">GA</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">GD</th>
                                <th class="px-1 py-3 text-xs font-medium uppercase tracking-wider">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="standings-table-body" class="bg-white divide-y divide-gray-200 text-sm">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="admin" class="page-section pt-8 pb-12">
                <h2 class="text-3xl font-bold text-center text-purple-700 mb-8">Admin Panel</h2>

                <div id="admin-password-prompt" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center">Admin Login</h3>
                    <input type="email" id="admin-email" placeholder="Admin Email" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-right" value="admin@example.com">
                    <input type="password" id="admin-password" placeholder="Password" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-right">
                    <p id="admin-password-error" class="text-red-500 text-sm mb-4 hidden text-center"></p>
                    <button id="admin-login-button" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition">Login</button>
                    <p class="text-xs text-gray-500 mt-2 text-center">Use admin@example.com and 123456</p>
                </div>

                <div id="admin-content" class="hidden">
                    <div class="text-center mb-8">
                        <button id="admin-logout-button" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition">Logout</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto mb-8">
                        <h3 class="text-2xl font-semibold text-purple-700 mb-4">Update Match Score & Details</h3>
                        <form id="update-score-form">
                            <div class="mb-4">
                                <label for="match-select" class="block text-gray-700 font-semibold mb-2">Select Match</label>
                                <select id="match-select" class="w-full p-3 border border-gray-300 rounded-lg" onchange="handleMatchSelectionChange()">
                                    <option value="">-- Select a Match --</option>
                                </select>
                            </div>

                            <div id="date-time-inputs" class="grid grid-cols-2 gap-4 mb-4 hidden">
                                <div>
                                    <label for="match-date" class="block text-gray-700 font-semibold mb-2">Date</label>
                                    <input type="date" id="match-date" class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="match-time" class="block text-gray-700 font-semibold mb-2">Time (24h)</label>
                                    <input type="time" id="match-time" class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label id="score1-label" for="score1" class="block text-gray-700 font-semibold mb-2">Team 1 Score</label>
                                    <input type="number" id="score1" min="0" class="w-full p-3 border border-gray-300 rounded-lg text-right" required>
                                </div>
                                <div>
                                    <label id="score2-label" for="score2" class="block text-gray-700 font-semibold mb-2">Team 2 Score</label>
                                    <input type="number" id="score2" min="0" class="w-full p-3 border border-gray-300 rounded-lg text-right" required>
                                </div>
                            </div>

                            <div class="mb-6 flex items-center">
                                <input type="checkbox" id="reset-match-checkbox" class="ml-2 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <label for="reset-match-checkbox" class="text-sm text-gray-700">Reset match (Upcoming, No score)</label>
                            </div>

                            <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Update Match</button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto">
                        <h3 class="text-2xl font-semibold text-purple-700 mb-4">Initialize Data</h3>
                        <p class="text-sm text-red-500 mb-4">Warning: This will clear all existing teams and matches and load default data!</p>
                        <button id="initialize-data-button" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition">Initialize/Reset Data</button>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button onclick="hideModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <button onclick="confirmCallback(true); hideConfirmModal()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-3">Yes, Confirm</button>
            <button onclick="confirmCallback(false); hideConfirmModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
        </div>
    </div>
    
    <script>
        // === FIREBASE CONFIGURATION ===
        // ğŸš¨ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸš¨
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø© (Compat)
        const db = firebase.firestore();
        const auth = firebase.auth(); 
        const appId = firebaseConfig.appId;

        let teamsData = [];
        let matchesData = [];
        let adminAuthenticated = false;
        let confirmCallback = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯


        // === INITIALIZATION & DATA LOADING ===
        function initializeApp() {
            setupRealtimeListeners();
            setupAuthListener();
            showSection('teams'); // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„ÙØ±Ù‚ ÙƒØ¨Ø¯Ø§ÙŠØ©
        }

        function setupAuthListener() {
            auth.onAuthStateChanged((user) => {
                adminAuthenticated = !!user;
                if (document.getElementById('admin').classList.contains('active')) {
                    showSection('admin'); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                }
            });
        }

        function setupRealtimeListeners() {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙØ±Ù‚
            db.collection(`artifacts/${appId}/public/data/teams`).onSnapshot(snapshot => {
                teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllActiveSections();
            }, error => console.error("Error fetching teams:", error));

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
            db.collection(`artifacts/${appId}/public/data/matches`).onSnapshot(snapshot => {
                matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllActiveSections();
            }, error => console.error("Error fetching matches:", error));
        }

        // === DEFAULT DATA SETUP ===
        function getDefaultTeams() {
            return [
                // ğŸ›‘ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ
                { name: "10D", logo: "https://placehold.co/100x100/3498db/000?text=10D", color: "blue" },
                { name: "12-E", logo: "https://placehold.co/100x100/2ecc71/000?text=12E", color: "green" },
                { name: "10A", logo: "https://placehold.co/100x100/f1c40f/000?text=10A", color: "yellow" },
                { name: "12D", logo: "https://placehold.co/100x100/e67e22/000?text=12D", color: "orange" },
                { name: "9D", logo: "https://placehold.co/100x100/9b59b6/000?text=9D", color: "purple" },
                { name: "9E", logo: "https://placehold.co/100x100/1abc9c/000?text=9E", color: "turquoise" },
                { name: "10E", logo: "https://placehold.co/100x100/e74c3c/000?text=10E", color: "red" },
                { name: "12A", logo: "https://placehold.co/100x100/34495e/fff?text=12A", color: "dark-blue" },
                { name: "11B", logo: "https://placehold.co/100x100/f39c12/000?text=11B", color: "gold" },
                { name: "9C", logo: "https://placehold.co/100x100/c0392b/fff?text=9C", color: "dark-red" },
                { name: "11D", logo: "https://placehold.co/100x100/7f8c8d/fff?text=11D", color: "gray" },
                { name: "11E", logo: "https://placehold.co/100x100/27ae60/fff?text=11E", color: "dark-green" }
            ];
        }

        document.getElementById('initialize-data-button').addEventListener('click', () => {
            showConfirmModal("Are you sure you want to **RESET ALL DATA** (Teams and Matches)? This action cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    await initializeDefaultData();
                    showModal("Data successfully reset and initialized!");
                }
            });
        });

        async function initializeDefaultData() {
            try {
                // 1. Ù…Ø³Ø­ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const teamsSnapshot = await db.collection(`artifacts/${appId}/public/data/teams`).get();
                const batch = db.batch();
                teamsSnapshot.docs.forEach(doc => batch.delete(doc.ref));

                // 2. Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const matchesSnapshot = await db.collection(`artifacts/${appId}/public/data/matches`).get();
                matchesSnapshot.docs.forEach(doc => batch.delete(doc.ref));

                await batch.commit();
                console.log("Existing data cleared.");

                // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const defaultTeams = getDefaultTeams();
                const teamsCollectionRef = db.collection(`artifacts/${appId}/public/data/teams`);
                const teamNames = [];
                for (const team of defaultTeams) {
                    await teamsCollectionRef.add({
                        name: team.name,
                        logo: team.logo,
                        color: team.color,
                        matchesPlayed: 0, wins: 0, draws: 0, losses: 0,
                        goalsFor: 0, goalsAgainst: 0, goalDifference: 0, points: 0,
                        // ğŸ›‘ ØªÙ… Ø­Ø°Ù Ø­Ù‚Ù„ captain Ù…Ù† Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
                    });
                    teamNames.push(team.name);
                }
                console.log("Default teams initialized.");

                // 4. ØªÙˆÙ„ÙŠØ¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Round Robin)
                const generatedMatches = generateRoundRobinSchedule(teamNames);
                const matchesCollectionRef = db.collection(`artifacts/${appId}/public/data/matches`);
                for (const match of generatedMatches) {
                    await matchesCollectionRef.add(match);
                }
                console.log("Default matches initialized.");

            } catch (error) {
                console.error("Error initializing default data:", error);
                showModal("Failed to initialize default data. Error: " + error.message);
            }
        }

        // --- DATABASE UPDATES ---
        async function updateMatchInFirestore(matchId, dataToUpdate) {
            try {
                const matchRef = db.collection(`artifacts/${appId}/public/data/matches`).doc(matchId);
                await matchRef.update(dataToUpdate);
                showModal("Match updated successfully!");
            } catch (error) {
                console.error("Error updating match:", error);
                showModal("Failed to update match. Ensure you are logged in as an admin. Error: " + error.message);
            }
        }

        // --- UI & MODAL ---
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('message-modal').style.display = 'none';
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-message').innerHTML = message; // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù€ bold
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            confirmCallback = null;
        }

        // --- LOGIC & CALCULATIONS ---
        function formatDate_YYYYMMDD(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
        }

        function formatTimeForDisplay(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12;
            return `${formattedHours.toString()}:${minutes} ${ampm}`;
        }

        function generateRoundRobinSchedule(teamNames) {
            const teams = [...teamNames];
            if (teams.length % 2 !== 0) teams.push('BYE'); // Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚ ÙˆÙ‡Ù…ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ ÙØ±Ø¯ÙŠØ§Ù‹
            const numTeams = teams.length;
            const allMatches = [];
            let currentDate = new Date('2025-09-01T00:00:00');
            const times = ['09:00', '09:40']; // Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
            let timeIndex = 0;

            for (let round = 0; round < numTeams - 1; round++) {
                for (let i = 0; i < numTeams / 2; i++) {
                    const team1 = teams[i];
                    const team2 = teams[numTeams - 1 - i];

                    if (team1 === 'BYE' || team2 === 'BYE') continue;

                    // ØªØ®Ø·ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø³Ø¨Øª
                    while (currentDate.getDay() === 5 || currentDate.getDay() === 6) { 
                        currentDate.setDate(currentDate.getDate() + 1);
                        timeIndex = 0;
                    }

                    allMatches.push({
                        team1,
                        team2,
                        date: currentDate.toISOString().slice(0, 10),
                        time: times[timeIndex],
                        location: "Main Stadium",
                        status: "upcoming",
                        score1: null, score2: null,
                        round: round + 1
                    });
                    
                    timeIndex++;
                    if (timeIndex >= times.length) {
                        timeIndex = 0;
                        currentDate.setDate(currentDate.getDate() + 1); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ Ù…Ø¨Ø§Ø±Ø§ØªÙŠÙ†
                    }
                }
                // ØªØ¯ÙˆÙŠØ± Ø§Ù„ÙØ±Ù‚ (Round Robin)
                teams.splice(1, 0, teams.pop());
            }
            return allMatches;
        }


        function updateTeamStats(teamName, opponentName, scoreTeam, scoreOpponent) {
            const team = teamsData.find(t => t.name === teamName);
            const opponent = teamsData.find(t => t.name === opponentName);
            if (!team || !opponent) return;

            team.matchesPlayed++;
            opponent.matchesPlayed++;
            team.goalsFor += scoreTeam;
            team.goalsAgainst += scoreOpponent;
            opponent.goalsFor += scoreOpponent;
            opponent.goalsAgainst += scoreTeam;

            if (scoreTeam > scoreOpponent) {
                team.wins++; team.points += 3; opponent.losses++;
            } else if (scoreTeam < scoreOpponent) {
                team.losses++; opponent.wins++; opponent.points += 3;
            } else {
                team.draws++; opponent.draws++; team.points += 1; opponent.points += 1;
            }
        }

        function calculateStandings() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
            teamsData.forEach(team => {
                team.matchesPlayed = 0; team.wins = 0; team.draws = 0; team.losses = 0;
                team.goalsFor = 0; team.goalsAgainst = 0; team.points = 0;
            });

            matchesData.forEach(match => {
                if (match.status === 'finished' && typeof match.score1 === 'number' && typeof match.score2 === 'number') {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ†
                    updateTeamStats(match.team1, match.team2, match.score1, match.score2);
                }
            });

            teamsData.forEach(team => {
                team.goalDifference = team.goalsFor - team.goalsAgainst;
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderTeams() {
            const container = document.getElementById('teams-container');
            container.innerHTML = '';
            
            if (!teamsData || teamsData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 col-span-full">No teams.</p>`;
                return;
            }
            
            // ğŸ›‘ Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 4 ÙØ±Ù‚ ÙÙ‚Ø·ØŒ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            const teamsToDisplay = teamsData.slice(0, 4); 

            teamsToDisplay.forEach(team => {
                container.innerHTML += `
                    <div class="bg-blue-50 rounded-xl card-shadow p-4 text-center border-2 border-blue-200 w-full max-w-xs mx-auto">
                        <div class="mx-auto mb-3 w-24 h-24 rounded-full border-4 border-${team.color}-400 flex items-center justify-center text-4xl font-bold text-white" style="background-color: ${team.color === 'yellow' ? '#f1c40f' : team.color === 'green' ? '#2ecc71' : team.color === 'blue' ? '#3498db' : '#ccc'}">
                            ${team.name}
                        </div>
                        <h3 class="text-2xl font-bold text-blue-800">${team.name}</h3>
                        </div>`;
            });
        }

        function renderMatches() {
            const upcomingContainer = document.getElementById('upcoming-matches');
            const pastContainer = document.getElementById('past-matches');
            upcomingContainer.innerHTML = '';
            pastContainer.innerHTML = '';
            
            if (!matchesData) return;

            const upcomingMatches = matchesData.filter(m => m.status === 'upcoming').sort((a, b) => new Date(a.date) - new Date(b.date));
            const pastMatches = matchesData.filter(m => m.status === 'finished').sort((a, b) => new Date(b.date) - new Date(a.date));

            // Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (Past Matches)
            if (pastMatches.length === 0) {
                pastContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No past matches.</p>`;
            } else {
                pastMatches.forEach(match => {
                    const day = new Date(match.date).toLocaleDateString('ar-EG', { weekday: 'long' });
                    
                    pastContainer.innerHTML += `
                        <div class="bg-red-50 rounded-xl card-shadow p-4 border-2 border-red-300">
                            <p class="text-sm text-gray-500 mb-2">${day}, ${formatDate_YYYYMMDD(match.date)}</p>
                            <p class="text-2xl font-bold text-center text-gray-800 mb-2">
                                <span>${match.team1}</span>&nbsp;
                                <span class="text-red-600">${match.score1}-${match.score2}</span>&nbsp;
                                <span>${match.team2}</span>
                            </p>
                            <p class="text-lg text-center text-red-700 font-semibold mb-3">Finished</p>
                        </div>`;
                });
            }

            // Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (Upcoming Matches)
            if (upcomingMatches.length === 0) {
                upcomingContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No upcoming matches.</p>`;
            } else {
                upcomingMatches.forEach(match => {
                    const day = new Date(match.date).toLocaleDateString('ar-EG', { weekday: 'long' });
                    upcomingContainer.innerHTML += `
                        <div class="bg-gray-50 rounded-xl card-shadow p-4 border-2 border-blue-300">
                            <p class="text-sm text-gray-500 mb-2">${day}, ${formatDate_YYYYMMDD(match.date)} - ${formatTimeForDisplay(match.time)}</p>
                            <p class="text-lg font-semibold text-gray-800 text-center">
                                <span>${match.team1}</span>&nbsp;
                                <span class="text-blue-600 font-bold text-xl">VS</span>&nbsp;
                                <span>${match.team2}</span>
                            </p>
                            <p class="text-lg text-center text-blue-500 font-semibold mb-2">Upcoming Match</p>
                            <p class="text-sm text-gray-600 text-center">Venue: ${match.location}</p>
                        </div>`;
                });
            }
        }

        function renderStandings() {
            const tableBody = document.getElementById('standings-table-body');
            tableBody.innerHTML = '';
            if (!teamsData || teamsData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-gray-500 py-4">No data available.</td></tr>`;
                return;
            }

            // ÙØ±Ø² Ø§Ù„ÙØ±Ù‚: Ø§Ù„Ù†Ù‚Ø§Ø· > ÙØ§Ø±Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù > Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
            const sortedTeams = [...teamsData].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });

            sortedTeams.forEach((team, index) => {
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-blue-600 font-semibold">${team.name}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.matchesPlayed}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.wins}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.draws}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.losses}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.goalsFor}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.goalsAgainst}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4">${team.goalDifference}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 font-bold text-blue-800">${team.points}</td>
                    </tr>`;
            });
        }

        function populateAdminMatchSelector() {
            const matchSelect = document.getElementById('match-select');
            const selectedValue = matchSelect.value;
            matchSelect.innerHTML = '<option value="">-- Select a Match --</option>';
            if (!matchesData) return;

            const sortedMatches = [...matchesData].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedMatches.forEach(match => {
                const statusText = match.status === 'upcoming' ? ' (Upcoming)' : ' (Finished)';
                const scoreText = match.status === 'finished' ? ` (${match.score1} - ${match.score2})` : '';
                matchSelect.innerHTML += `<option value="${match.id}">${match.team1} vs ${match.team2} (${formatDate_YYYYMMDD(match.date)})${scoreText}${statusText}</option>`;
            });
            matchSelect.value = selectedValue;
        }

        function handleMatchSelectionChange() {
            const selectedMatchId = document.getElementById('match-select').value;
            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const score1Label = document.getElementById('score1-label');
            const score2Label = document.getElementById('score2-label');
            const dateInput = document.getElementById('match-date');
            const timeInput = document.getElementById('match-time');
            const dateTimeContainer = document.getElementById('date-time-inputs');

            if (selectedMatchId) {
                const selectedMatch = matchesData.find(m => m.id == selectedMatchId);
                if (selectedMatch) {
                    dateTimeContainer.style.display = 'grid';
                    score1Label.textContent = `Score ${selectedMatch.team1}`;
                    score2Label.textContent = `Score ${selectedMatch.team2}`;
                    
                    // ÙŠØªÙ… Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ù…Ù†ØªÙ‡ÙŠØ©
                    score1Input.value = selectedMatch.status === 'finished' ? selectedMatch.score1 ?? '' : '';
                    score2Input.value = selectedMatch.status === 'finished' ? selectedMatch.score2 ?? '' : '';

                    dateInput.value = selectedMatch.date || '';
                    timeInput.value = selectedMatch.time || '';
                }
            } else {
                dateTimeContainer.style.display = 'none';
                score1Label.textContent = 'Team 1 Score';
                score2Label.textContent = 'Team 2 Score';
                score1Input.value = '';
                score2Input.value = '';
                dateInput.value = '';
                timeInput.value = '';
            }
        }


        function renderAllActiveSections() {
            const activeSection = document.querySelector('.page-section.active');
            if (!activeSection) {
                showSection('home');
                return;
            }
            const sectionId = activeSection.id;

            if (sectionId === 'teams') renderTeams();
            else if (sectionId === 'matches') renderMatches();
            else if (sectionId === 'standings') {
                calculateStandings();
                renderStandings();
            } 
            else if (sectionId === 'admin' && adminAuthenticated) {
                populateAdminMatchSelector();
                handleMatchSelectionChange();
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'admin') {
                if (adminAuthenticated) {
                    document.getElementById('admin-password-prompt').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    populateAdminMatchSelector();
                    handleMatchSelectionChange();
                } else {
                    document.getElementById('admin-password-prompt').style.display = 'block';
                    document.getElementById('admin-content').style.display = 'none';
                }
            } else {
                renderAllActiveSections();
            }
        }

        // --- EVENT LISTENERS ---
        document.querySelectorAll('.nav-button[data-target]').forEach(button => {
            button.addEventListener('click', (e) => showSection(e.currentTarget.dataset.target));
        });

        document.getElementById('admin-login-button').addEventListener('click', async () => {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorMsg = document.getElementById('admin-password-error');
            errorMsg.style.display = 'none';

            if (!email || !password) {
                errorMsg.textContent = "Please enter email and password.";
                errorMsg.style.display = 'block';
                return;
            }
            try {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ù‹Ø§ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
                await auth.signInWithEmailAndPassword(email, password);
                showModal('Logged in successfully as admin!');
                showSection('admin');
            } catch (error) {
                errorMsg.textContent = 'Incorrect email or password.';
                errorMsg.style.display = 'block';
            }
        });

        document.getElementById('admin-logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                showModal('Logged out successfully.');
                showSection('home');
            }).catch((error) => console.error('Sign out error', error));
        });

        document.getElementById('update-score-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const matchId = document.getElementById('match-select').value;
            if (!matchId) {
                showModal('Please select a match.');
                return;
            }
            
            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const dateInput = document.getElementById('match-date');
            const timeInput = document.getElementById('match-time');
            const resetMatchCheckbox = document.getElementById('reset-match-checkbox');
            
            let dataToUpdate = {
                date: dateInput.value,
                time: timeInput.value
            };

            if (resetMatchCheckbox.checked) {
                dataToUpdate.status = 'upcoming';
                dataToUpdate.score1 = null;
                dataToUpdate.score2 = null;
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                showConfirmModal("Are you sure you want to **RESET** this match? Score will be cleared and status set to Upcoming.", (confirmed) => {
                    if (confirmed) {
                        updateMatchInFirestore(matchId, dataToUpdate);
                    }
                });
                return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            const score1 = parseInt(score1Input.value);
            const score2 = parseInt(score2Input.value);
            
            if (isNaN(score1) || isNaN(score2)) {
                 showModal('Please enter valid scores (numbers only).');
                 return;
            }

            dataToUpdate.score1 = score1;
            dataToUpdate.score2 = score2;
            dataToUpdate.status = 'finished';

            await updateMatchInFirestore(matchId, dataToUpdate);
        });
    </script>
</body>
</html>
