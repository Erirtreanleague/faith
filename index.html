<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eritrean International League</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom font for better Arabic display */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            /* Deeper, more vibrant gradient for the background */
            background: linear-gradient(135deg, #e0f2fe 0%, #cce7ff 50%, #b3daff 100%);
            background-attachment: fixed;
            position: relative;
            z-index: 1;
        }

        /* Watermark/Background Pattern - Eritrean Emblem and Flag (Grayscale) in a chessboard-like pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Combine both images with different positions and repeat patterns for a chessboard effect */
            background-image:
                url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Coat_of_arms_of_Eritrea.svg/800px-Coat_of_arms_of_Eritrea.svg.png'), /* Emblem */
                url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Flag_of_Eritrea.svg/800px-Flag_of_Eritrea.svg.png'); /* Flag */
            background-repeat: repeat;
            background-size: 200px auto; /* Size of each individual pattern square, adjust as needed */
            /* Position them to create an alternating effect (offset by half the size) */
            background-position:
                0px 0px, /* Emblem starts at top-left of its "cell" */
                100px 100px; /* Flag starts offset by half of background-size, creating a checkerboard */
            opacity: 0.1; /* Slightly reduced opacity for subtlety */
            filter: grayscale(100%); /* Apply grayscale filter to both images */
            z-index: -1;
            pointer-events: none;
        }

        /* Hide sections by default, show active one */
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        /* Ensure table cells have appropriate padding and alignment */
        th, td {
            text-align: right;
        }
        th {
            font-size: 0.8rem;
        }
        td {
            font-size: 0.9rem;
        }
        /* Responsive table scrolling for small screens */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Custom colors inspired by Eritrean flag */
        .bg-eritrea-red { background-color: #FF0000; }
        .bg-eritrea-green { background-color: #008000; }
        .bg-eritrea-blue { background-color: #4682B4; }
        .bg-eritrea-yellow { background-color: #FFD700; }

        .text-eritrea-red { color: #FF0000; }
        .text-eritrea-green { color: #008000; }
        .text-eritrea-blue { color: #4682B4; }
        .text-eritrea-yellow { color: #FFD700; }

        /* Custom gradient for navigation bar - more vibrant */
        .nav-gradient {
            background: linear-gradient(90deg, #006400 0%, #3a6b9a 100%); /* Darker green to slightly darker blue */
        }

        /* Enhanced button styles */
        .nav-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
        .nav-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease-in-out;
            transform: skewX(-20deg);
        }
        .nav-button:hover::before {
            left: 100%;
        }

        /* Hide admin content by default */
        #admin-content, #admin-password-error {
            display: none;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* Subtle blur effect */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px; /* Increased padding */
            border-radius: 15px; /* More rounded corners */
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); /* Stronger shadow */
            max-width: 450px; /* Slightly wider */
            text-align: center;
            position: relative;
            animation: fadeInScale 0.4s forwards; /* New animation */
            border: 2px solid #4682B4; /* Blue border */
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .close-button {
            color: #888;
            float: left; /* Adjusted for RTL */
            font-size: 32px; /* Larger close button */
            font-weight: bold;
            position: absolute;
            top: 10px;
            left: 15px; /* Adjusted for RTL */
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        /* Enhanced card styles */
        .card-shadow {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2), 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        /* Specific styles for home section buttons */
        .home-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .home-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }
        .home-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.5s ease-in-out;
            transform: skewX(-30deg);
        }
        .home-button:hover::before {
            left: 100%;
        }

        /* Table row hover effect */
        .standings-table-row:hover {
            background-color: #f0f9ff;
        }

        /* Input and Select focus styles */
        input:focus, select:focus {
            border-color: #4682B4 !important;
            box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.3) !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

    <!-- Navigation Bar -->
    <nav class="nav-gradient p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-white text-base sm:text-xl md:text-3xl font-bold rounded-md p-2">Eritrean International League</a>
            <div class="space-x-1 sm:space-x-2 md:space-x-4 space-x-reverse flex items-center">
                <button class="nav-button text-white hover:text-blue-200 p-1 text-xs sm:p-2 sm:text-sm lg:p-3 lg:text-lg rounded-lg transition duration-300 font-semibold" data-target="home">الرئيسية</button>
                <button class="nav-button text-white hover:text-blue-200 p-1 text-xs sm:p-2 sm:text-sm lg:p-3 lg:text-lg rounded-lg transition duration-300 font-semibold" data-target="teams">الفرق</button>
                <button class="nav-button text-white hover:text-blue-200 p-1 text-xs sm:p-2 sm:text-sm lg:p-3 lg:text-lg rounded-lg transition duration-300 font-semibold" data-target="matches">المباريات</button>
                <button class="nav-button text-white hover:text-blue-200 p-1 text-xs sm:p-2 sm:text-sm lg:p-3 lg:text-lg rounded-lg transition duration-300 font-semibold" data-target="standings">الترتيب</button>
                <button class="nav-button text-white hover:text-yellow-300 p-1 text-xs sm:p-2 sm:text-sm lg:p-3 lg:text-lg rounded-lg transition duration-300 font-semibold border border-transparent hover:border-white" data-target="admin">المسؤول</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto py-4 px-2 sm:py-8 sm:px-4 flex-grow">

        <!-- User ID Display -->
        <div class="text-center mb-4 text-gray-600 text-sm">
            معرف المستخدم: <span id="user-id-display" class="font-mono text-xs bg-gray-200 p-1 rounded">جار التحميل...</span>
        </div>

        <!-- Home Section -->
        <section id="home" class="page-section active bg-white rounded-xl card-shadow p-4 sm:p-8 md:p-12 text-center">
            <h2 class="text-3xl sm:text-5xl font-extrabold text-eritrea-red mb-4 sm:mb-6">أهلاً بك في Eritrean International League!</h2>
            <p class="text-base sm:text-xl text-gray-700 leading-relaxed mb-6 sm:mb-8">هنا يمكنك متابعة كل ما يتعلق بدوري السفارة الإرترية.</p>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mt-6 sm:mt-10">
                <div class="bg-blue-50 p-4 sm:p-6 rounded-lg card-shadow border-b-4 border-blue-500">
                    <h3 class="text-xl sm:text-3xl font-bold text-blue-700 mb-2 sm:mb-3">الفرق</h3>
                    <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">تعرف على الفرق المشاركة واللاعبين المميزين.</p>
                    <button class="nav-button home-button bg-blue-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-sm sm:text-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md" data-target="teams">عرض الفرق</button>
                </div>
                <div class="bg-green-50 p-4 sm:p-6 rounded-lg card-shadow border-b-4 border-green-500">
                    <h3 class="text-xl sm:text-3xl font-bold text-green-700 mb-2 sm:mb-3">المباريات</h3>
                    <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">اكتشف مواعيد المباريات والنتائج المباشرة.</p>
                    <button class="nav-button home-button bg-green-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-sm sm:text-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md" data-target="matches">عرض المباريات</button>
                </div>
                <div class="bg-yellow-50 p-4 sm:p-6 rounded-lg card-shadow border-b-4 border-yellow-500">
                    <h3 class="text-xl sm:text-3xl font-bold text-yellow-700 mb-2 sm:mb-3">ترتيب الدوري</h3>
                    <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">اطلع على ترتيب الفرق في الدوري وعدد النقاط.</p>
                    <button class="nav-button home-button bg-yellow-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-sm sm:text-lg font-semibold hover:bg-yellow-700 transition duration-300 shadow-md" data-target="standings">عرض الترتيب</button>
                </div>
            </div>
        </section>

        <!-- Teams Section -->
        <section id="teams" class="page-section bg-white rounded-xl card-shadow p-4 sm:p-8 md:p-12">
            <h2 class="text-2xl sm:text-4xl font-bold text-eritrea-blue text-center mb-6 sm:mb-10">الفرق المشاركة</h2>
            <div id="teams-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                <!-- Team cards will be dynamically inserted here -->
            </div>
        </section>

        <!-- Matches Section -->
        <section id="matches" class="page-section bg-white rounded-xl card-shadow p-4 sm:p-8 md:p-12">
            <h2 class="text-2xl sm:text-4xl font-bold text-eritrea-blue text-center mb-6 sm:mb-10">جدول ونتائج المباريات</h2>
            
            <!-- Past Matches Section -->
            <div>
                <h3 class="text-xl sm:text-3xl font-semibold text-eritrea-red mb-4 sm:mb-6">نتائج المباريات</h3>
                <div id="past-matches" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <!-- Past match cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Upcoming Matches Section -->
            <div class="mt-6 sm:mt-8">
                <h3 id="upcoming-matches-heading" class="text-xl sm:text-3xl font-semibold text-eritrea-green mb-4 sm:mb-6">المباريات القادمة</h3>
                <div id="upcoming-matches" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <!-- Upcoming match cards will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Standings Section -->
        <section id="standings" class="page-section bg-white rounded-xl card-shadow p-4 sm:p-8 md:p-12">
            <h2 class="text-2xl sm:text-4xl font-bold text-eritrea-blue text-center mb-6 sm:mb-10">ترتيب الدوري</h2>
            <div class="max-w-full mx-auto bg-white rounded-xl card-shadow overflow-hidden table-responsive">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-eritrea-green text-white">
                        <tr>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">الترتيب</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">الفريق</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">لعب</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">فاز</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">تعادل</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">خسر</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">له</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">عليه</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">الفرق</th>
                            <th scope="col" class="px-1 py-2 sm:px-6 sm:py-3 text-right text-xs font-medium uppercase tracking-wider">النقاط</th>
                        </tr>
                    </thead>
                    <tbody id="standings-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="page-section bg-white rounded-xl card-shadow p-4 sm:p-8 md:p-12">
            <h2 class="text-2xl sm:text-4xl font-bold text-eritrea-blue text-center mb-6 sm:mb-10">لوحة تحكم المسؤول</h2>
            <!-- Password Prompt -->
            <div id="admin-password-prompt" class="max-w-md mx-auto">
                <label for="admin-password" class="block text-base sm:text-lg font-medium text-gray-700 mb-2">الرجاء إدخال كلمة المرور</label>
                <input type="password" id="admin-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base sm:text-lg p-2 sm:p-3">
                <button id="admin-login-button" class="mt-4 w-full bg-blue-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-base sm:text-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md home-button">دخول</button>
                <p id="admin-password-error" class="text-red-500 mt-2 text-center text-sm sm:text-base">كلمة المرور غير صحيحة.</p>
            </div>
            <!-- Admin Content -->
            <div id="admin-content" class="max-w-2xl mx-auto">
                <h3 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 sm:mb-6">تحديث نتائج المباريات</h3>
                <form id="update-score-form">
                    <div class="mb-4">
                        <label for="match-select" class="block text-base sm:text-lg font-medium text-gray-700 mb-2">اختر المباراة</label>
                        <select id="match-select" class="block w-full mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base sm:text-lg p-2 sm:p-3"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="score1" id="score1-label" class="block text-base sm:text-lg font-medium text-gray-700 mb-2">نتيجة الفريق الأول</label>
                            <input type="number" id="score1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base sm:text-lg p-2 sm:p-3">
                        </div>
                        <div>
                            <label for="score2" id="score2-label" class="block text-base sm:text-lg font-medium text-gray-700 mb-2">نتيجة الفريق الثاني</label>
                            <input type="number" id="score2" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base sm:text-lg p-2 sm:p-3">
                        </div>
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="reset-match-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="reset-match-checkbox" class="mr-2 block text-base sm:text-lg text-gray-900">إعادة تعيين المباراة (جعلها قادمة)</label>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-base sm:text-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md home-button">تحديث النتيجة</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 sm:py-6 text-center mt-auto">
        <div class="container mx-auto">
            <p class="text-sm sm:text-base">&copy; 2025 Eritrean International League. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal">
        <div class="modal-content p-4 sm:p-6">
            <span class="close-button" id="close-modal-button">&times;</span>
            <p id="modal-message" class="text-base sm:text-lg text-gray-800 mb-3 sm:mb-4"></p>
            <button id="modal-ok-button" class="bg-blue-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-full text-base sm:text-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md home-button">موافق</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, collection, onSnapshot, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let app;
        let db;
        let auth;
        let userId;
        let adminAuthenticated = false; // Flag to track admin authentication status

        // Data arrays, will be populated from Firestore
        let teamsData = [];
        let matchesData = [];

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        /**
         * Initializes Firebase and authenticates the user.
         * Sets up Firestore and authentication listeners.
         */
        async function initializeFirebase() {
            try {
                // Use platform-provided config if available, otherwise use a hardcoded fallback.
                // This ensures the app works both on the platform and on external sites like GitHub Pages.
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyA1GXnKdeQnWYopmMR29YtBbwpJgdOXdDk",
                        authDomain: "eritrean-international-l-7bc64.firebaseapp.com",
                        projectId: "eritrean-international-l-7bc64",
                        storageBucket: "eritrean-international-l-7bc64.appspot.com",
                        messagingSenderId: "188029452555",
                        appId: "1:188029452555:web:db61e38cfb495aaa18e20e"
                    };
                
                // Use platform-provided app ID for path, or a fallback for external hosting.
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'eritrea-league-app-gh';

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                // Get Firestore and Auth instances
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable Firestore debug logging
                setLogLevel('debug');
                
                console.log("Firebase Initialized. App ID for path:", appId);

                // Authenticate user using custom token if available, otherwise anonymously.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("User authenticated:", userId);
                        // Once authenticated, start listening for data and initialize default data
                        setupFirestoreListeners(appId);
                        initializeDefaultData(appId); 
                    } else {
                        userId = 'anonymous-user'; // Fallback
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("No user authenticated, using anonymous fallback.");
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showModal("حدث خطأ أثناء تهيئة التطبيق: " + error.message);
            }
        }

        // --- FIRESTORE DATA MANAGEMENT ---
        /**
         * Sets up real-time listeners for teams and matches data from Firestore.
         * @param {string} appId - The application ID for the Firestore path.
         */
        function setupFirestoreListeners(appId) {
            const teamsCollectionRef = collection(db, `artifacts/${appId}/public/data/teams`);
            onSnapshot(teamsCollectionRef, (snapshot) => {
                teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Teams data updated:", teamsData);
                // Re-render relevant sections
                renderAllActiveSections();
            }, (error) => {
                console.error("Error listening to teams data:", error);
                showModal("خطأ في جلب بيانات الفرق: " + error.message);
            });

            const matchesCollectionRef = collection(db, `artifacts/${appId}/public/data/matches`);
            onSnapshot(matchesCollectionRef, (snapshot) => {
                matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Matches data updated:", matchesData);
                // Re-render relevant sections
                renderAllActiveSections();
            }, (error) => {
                console.error("Error listening to matches data:", error);
                showModal("خطأ في جلب بيانات المباريات: " + error.message);
            });
        }

        /**
        * Initializes default data in Firestore if collections are empty.
        * @param {string} appId - The application ID for the Firestore path.
        */
        async function initializeDefaultData(appId) {
            try {
                const teamsCollectionRef = collection(db, `artifacts/${appId}/public/data/teams`);
                const teamsSnapshot = await getDocs(teamsCollectionRef);

                let currentTeamsInDb = [];
                if (teamsSnapshot.empty) {
                    console.log("Initializing default teams data in Firestore...");
                    const defaultTeams = [
                        { name: "9D", logo: "https://placehold.co/100x100/ADD8E6/000000?text=9D", captain: "أحمد", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "12D", logo: "https://placehold.co/100x100/FFD700/000000?text=12D", captain: "خالد", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "12A", logo: "https://placehold.co/100x100/C0C0C0/000000?text=12A", captain: "محمد", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "11D", logo: "https://placehold.co/100x100/FFB6C1/000000?text=11D", captain: "يوسف", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "10D", logo: "https://placehold.co/100x100/A2D9CE/000000?text=10D", captain: "فهد", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "10E", logo: "https://placehold.co/100x100/D7BDE2/000000?text=10E", captain: "علي", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "9C", logo: "https://placehold.co/100x100/FAD7A0/000000?text=9C", captain: "سعيد", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "9E", logo: "https://placehold.co/100x100/A9CCE3/000000?text=9E", captain: "ناصر", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "11A", logo: "https://placehold.co/100x100/F5CBA7/000000?text=11A", captain: "محمود", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "11E", logo: "https://placehold.co/100x100/AED6F1/000000?text=11E", captain: "عمر", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 },
                        { name: "11B", logo: "https://placehold.co/100x100/F1948A/000000?text=11B", captain: "بدر", playersCount: 10, startersCount: 6, points: 0, matchesPlayed: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 }
                    ];
                    for (const team of defaultTeams) {
                        await addDoc(teamsCollectionRef, team);
                    }
                    currentTeamsInDb = defaultTeams;
                } else {
                    currentTeamsInDb = teamsSnapshot.docs.map(doc => doc.data());
                }

                const matchesCollectionRef = collection(db, `artifacts/${appId}/public/data/matches`);
                const matchesSnapshot = await getDocs(matchesCollectionRef);

                if (matchesSnapshot.empty && currentTeamsInDb.length > 0) {
                    console.log("Generating and initializing default matches data in Firestore...");
                    const generatedMatches = generateRoundRobinSchedule(currentTeamsInDb.map(team => team.name));
                    for (const match of generatedMatches) {
                        await addDoc(matchesCollectionRef, match);
                    }
                }
            } catch (error) {
                console.error("Error initializing default data:", error);
                showModal("حدث خطأ أثناء تهيئة البيانات الأولية: " + error.message);
            }
        }
        
        /**
        * Rerenders content for any currently visible section.
        * This is useful after data updates from Firestore.
        */
        function renderAllActiveSections() {
            const activeSection = document.querySelector('.page-section.active');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            if (sectionId === 'teams') {
                renderTeams();
            } else if (sectionId === 'matches') {
                renderMatches();
            } else if (sectionId === 'standings') {
                calculateStandings();
                renderStandings();
            } else if (sectionId === 'admin' && adminAuthenticated) {
                populateAdminMatchSelector();
                updateScoreLabels();
            }
        }


        /**
         * Updates a match's score and status in Firestore.
         * @param {string} matchId - The ID of the match document to update.
         * @param {number|null} score1 - The score for team 1.
         * @param {number|null} score2 - The score for team 2.
         * @param {string} status - The new status of the match ('upcoming' or 'finished').
         */
        async function updateMatchInFirestore(matchId, score1, score2, status) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'eritrea-league-app-gh';
                const matchRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
                await updateDoc(matchRef, {
                    score1: score1,
                    score2: score2,
                    status: status
                });
                console.log(`Match ${matchId} updated successfully to status: ${status} in Firestore.`);
            } catch (error) {
                console.error("Error updating match in Firestore:", error);
                showModal("خطأ في تحديث نتيجة المباراة: " + error.message);
            }
        }

        // --- UI HELPER FUNCTIONS ---
        function showModal(message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('message-modal').style.display = 'none';
        }

        // --- CORE LOGIC FUNCTIONS ---
        function generateRoundRobinSchedule(teamNames) {
            const teams = [...teamNames];
            if (teams.length % 2 !== 0) {
                teams.push('BYE');
            }
            const numTeams = teams.length;
            const allMatches = [];
            let currentDate = new Date('2025-09-01T00:00:00');
            const times = ['09:00 صباحاً', '09:40 صباحاً'];
            let timeIndex = 0;
            let matchesOnCurrentDay = 0;

            for (let round = 0; round < numTeams - 1; round++) {
                for (let i = 0; i < numTeams / 2; i++) {
                    const team1 = teams[i];
                    const team2 = teams[numTeams - 1 - i];

                    if (team1 === 'BYE' || team2 === 'BYE') continue;
                    
                    while (currentDate.getDay() === 5 || currentDate.getDay() === 6) { // Skip Fri/Sat
                        currentDate.setDate(currentDate.getDate() + 1);
                        timeIndex = 0;
                        matchesOnCurrentDay = 0;
                    }

                    allMatches.push({
                        team1,
                        team2,
                        date: currentDate.toISOString().slice(0, 10),
                        time: times[timeIndex],
                        location: "الملعب الرئيسي",
                        status: "upcoming",
                        score1: null,
                        score2: null,
                        round: round + 1
                    });

                    matchesOnCurrentDay++;
                    if (matchesOnCurrentDay >= 2) {
                        matchesOnCurrentDay = 0;
                        timeIndex = 0;
                        currentDate.setDate(currentDate.getDate() + 1);
                    } else {
                        timeIndex++;
                    }
                }
                // Rotate teams for the next round
                teams.splice(1, 0, teams.pop());
            }
            return allMatches;
        }

        function updateTeamStats(teamName, opponentName, scoreTeam, scoreOpponent) {
            const team = teamsData.find(t => t.name === teamName);
            const opponent = teamsData.find(t => t.name === opponentName);
            if (!team || !opponent) return;

            team.matchesPlayed++;
            opponent.matchesPlayed++;
            team.goalsFor += scoreTeam;
            team.goalsAgainst += scoreOpponent;
            opponent.goalsFor += scoreOpponent;
            opponent.goalsAgainst += scoreTeam;

            if (scoreTeam > scoreOpponent) {
                team.wins++;
                team.points += 3;
                opponent.losses++;
            } else if (scoreTeam < scoreOpponent) {
                team.losses++;
                opponent.wins++;
                opponent.points += 3;
            } else {
                team.draws++;
                opponent.draws++;
                team.points += 1;
                opponent.points += 1;
            }
        }

        function calculateStandings() {
            teamsData.forEach(team => {
                team.matchesPlayed = 0;
                team.wins = 0;
                team.draws = 0;
                team.losses = 0;
                team.goalsFor = 0;
                team.goalsAgainst = 0;
                team.points = 0;
            });

            matchesData.forEach(match => {
                if (match.status === 'finished' && typeof match.score1 === 'number' && typeof match.score2 === 'number') {
                    updateTeamStats(match.team1, match.team2, match.score1, match.score2);
                }
            });

            teamsData.forEach(team => {
                team.goalDifference = team.goalsFor - team.goalsAgainst;
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderTeams() {
            const teamsContainer = document.getElementById('teams-container');
            teamsContainer.innerHTML = '';
            if (teamsData.length === 0) {
                teamsContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا توجد فرق متاحة حالياً.</p>`;
                return;
            }
            teamsData.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = "bg-blue-50 rounded-xl card-shadow p-4 sm:p-6 text-center border-2 border-blue-200";
                teamCard.innerHTML = `
                    <img src="${team.logo}" alt="${team.name} Logo" class="mx-auto mb-2 sm:mb-4 rounded-full border-4 border-blue-400 w-20 h-20 sm:w-24 sm:h-24 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ccc/000?text=Logo';">
                    <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-1 sm:mb-2">${team.name}</h3>
                    <p class="text-sm sm:text-lg text-gray-700 mb-2">القائد: <span class="font-semibold">${team.captain}</span></p>
                `;
                teamsContainer.appendChild(teamCard);
            });
        }

        function renderMatches() {
            const upcomingContainer = document.getElementById('upcoming-matches');
            const pastContainer = document.getElementById('past-matches');
            const upcomingHeading = document.getElementById('upcoming-matches-heading');
            upcomingContainer.innerHTML = '';
            pastContainer.innerHTML = '';

            const upcomingMatches = matchesData.filter(m => m.status === 'upcoming');
            const pastMatches = matchesData.filter(m => m.status === 'finished');
            
            // Sort matches by date
            upcomingMatches.sort((a,b) => new Date(a.date) - new Date(b.date));
            pastMatches.sort((a,b) => new Date(b.date) - new Date(a.date));

            if (pastMatches.length === 0) {
                pastContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا توجد مباريات سابقة حالياً.</p>`;
            } else {
                pastMatches.forEach(match => {
                    const dayOfWeek = new Date(match.date).toLocaleDateString('ar-SA', { weekday: 'long' });
                    pastContainer.innerHTML += `
                        <div class="bg-red-50 rounded-xl card-shadow p-4 sm:p-6 border-2 border-red-300">
                            <p class="text-xs sm:text-sm text-gray-500 mb-1 sm:mb-2">${dayOfWeek}، ${match.date}</p>
                            <p class="text-lg sm:text-2xl font-bold text-center text-gray-800 mb-2 sm:mb-3">
                                ${match.team1} <span class="text-red-600">${match.score1} - ${match.score2}</span> ${match.team2}
                            </p>
                            <p class="text-base sm:text-lg text-center text-red-700 font-semibold">انتهت</p>
                        </div>`;
                });
            }

            if (upcomingMatches.length === 0) {
                upcomingHeading.style.display = 'block';
                upcomingContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا توجد مباريات قادمة.</p>`;
            } else {
                upcomingHeading.style.display = 'block';
                upcomingMatches.forEach(match => {
                   const dayOfWeek = new Date(match.date).toLocaleDateString('ar-SA', { weekday: 'long' });
                   upcomingContainer.innerHTML += `
                        <div class="bg-gray-50 rounded-xl card-shadow p-4 sm:p-6 border-2 border-blue-300">
                            <p class="text-xs sm:text-sm text-gray-500 mb-1 sm:mb-2">${dayOfWeek}، ${match.date} - ${match.time}</p>
                            <p class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">${match.team1} <span class="text-blue-600 font-bold text-lg sm:text-xl">VS</span> ${match.team2}</p>
                            <p class="text-base sm:text-lg text-center text-blue-500 font-semibold mb-2 sm:mb-3">مباراة قادمة</p>
                            <p class="text-xs sm:text-sm text-gray-600 text-center">المكان: ${match.location}</p>
                        </div>`;
                });
            }
        }

        function renderStandings() {
            const tableBody = document.getElementById('standings-table-body');
            tableBody.innerHTML = '';
            if (teamsData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-gray-500 py-4">لا توجد بيانات ترتيب متاحة حالياً.</td></tr>`;
                return;
            }

            const sortedTeams = [...teamsData].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });

            sortedTeams.forEach((team, index) => {
                tableBody.innerHTML += `
                    <tr class="standings-table-row">
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.name}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.matchesPlayed}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.wins}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.draws}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.losses}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.goalsFor}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.goalsAgainst}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-700">${team.goalDifference}</td>
                        <td class="px-1 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-bold text-blue-800">${team.points}</td>
                    </tr>`;
            });
        }

        function populateAdminMatchSelector() {
            const matchSelect = document.getElementById('match-select');
            const selectedValue = matchSelect.value;
            matchSelect.innerHTML = '<option value="">-- اختر مباراة لتحديثها --</option>';
            
            const sortedMatches = [...matchesData].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedMatches.forEach(match => {
                const statusText = match.status === 'upcoming' ? ' (قادمة)' : ' (انتهت)';
                const scoreText = match.status === 'finished' ? ` (${match.score1} - ${match.score2})` : '';
                matchSelect.innerHTML += `<option value="${match.id}">${match.team1} vs ${match.team2} (${match.date})${scoreText}${statusText}</option>`;
            });
            matchSelect.value = selectedValue; // Restore selection
        }
        
        function updateScoreLabels() {
            const matchSelect = document.getElementById('match-select');
            const selectedMatchId = matchSelect.value;
            const score1Label = document.getElementById('score1-label');
            const score2Label = document.getElementById('score2-label');
            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const resetMatchCheckbox = document.getElementById('reset-match-checkbox');

            if (selectedMatchId) {
                const selectedMatch = matchesData.find(m => m.id == selectedMatchId);
                if (selectedMatch) {
                    score1Label.textContent = `نتيجة ${selectedMatch.team1}`;
                    score2Label.textContent = `نتيجة ${selectedMatch.team2}`;
                    
                    if (selectedMatch.status === 'finished') {
                        score1Input.value = selectedMatch.score1 ?? '';
                        score2Input.value = selectedMatch.score2 ?? '';
                        resetMatchCheckbox.checked = false;
                    } else {
                        score1Input.value = '';
                        score2Input.value = '';
                        resetMatchCheckbox.checked = false; // Default to not resetting
                    }
                }
            } else {
                score1Label.textContent = 'نتيجة الفريق الأول';
                score2Label.textContent = 'نتيجة الفريق الثاني';
                score1Input.value = '';
                score2Input.value = '';
                resetMatchCheckbox.checked = false;
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'admin') {
                if (adminAuthenticated) {
                    document.getElementById('admin-password-prompt').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    populateAdminMatchSelector();
                    updateScoreLabels();
                } else {
                    document.getElementById('admin-password-prompt').style.display = 'block';
                    document.getElementById('admin-content').style.display = 'none';
                }
            } else {
                renderAllActiveSections(); // Render the section that was just made active
            }
        }

        // --- EVENT LISTENERS ---
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => showSection(e.target.dataset.target));
        });

        document.getElementById('admin-login-button').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            const errorMsg = document.getElementById('admin-password-error');
            if (password === 'admin123') { // Simple hardcoded password
                adminAuthenticated = true;
                errorMsg.style.display = 'none';
                showSection('admin');
            } else {
                errorMsg.style.display = 'block';
            }
        });
        
        document.getElementById('match-select').addEventListener('change', updateScoreLabels);

        document.getElementById('update-score-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const matchId = document.getElementById('match-select').value;
            if (!matchId) {
                showModal('الرجاء اختيار مباراة لتحديثها.');
                return;
            }

            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const resetMatchCheckbox = document.getElementById('reset-match-checkbox');

            let newStatus, newScore1, newScore2;

            if (resetMatchCheckbox.checked) {
                newStatus = 'upcoming';
                newScore1 = null;
                newScore2 = null;
            } else {
                newScore1 = parseInt(score1Input.value, 10);
                newScore2 = parseInt(score2Input.value, 10);
                if (isNaN(newScore1) || isNaN(newScore2)) {
                    showModal('الرجاء إدخال نتيجة رقمية صحيحة للمباراة.');
                    return;
                }
                newStatus = 'finished';
            }
            
            await updateMatchInFirestore(matchId, newScore1, newScore2, newStatus);
            document.getElementById('update-score-form').reset();
            updateScoreLabels(); // Reset labels
            showModal('تم تحديث حالة ونتيجة المباراة بنجاح!');
        });

        document.getElementById('close-modal-button').addEventListener('click', hideModal);
        document.getElementById('modal-ok-button').addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('message-modal')) {
                hideModal();
            }
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            showSection('home');
        });
    </script>
</body>
</html>
